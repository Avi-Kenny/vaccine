---
title: "Basic package workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Basic package workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}

library(vaccine)

```

The `load_data` function takes in raw data and creates a data object that can be accepted by various estimation functions. We use publicly-avaliable data from the HVTN 505 HIV vaccine efficacy trial as our example.

```{r}

data(hvtn505)

dat <- load_data(
  time = "HIVwk28preunblfu", # HIVwk28preunblfu
  event = "HIVwk28preunbl", # HIVwk28preunbl
  vacc = "trt",
  marker = "logpctpos_scaled",
  covariates = c("age", "BMI", "bhvrisk"),
  weights = "wt",
  ph2 = "casecontrol",
  data = hvtn505
)

```

The `summary_stats` function gives us some useful summaries of the dataset.

```{r}

summary_stats(dat)

```

The `est_overall` function allows us to estimate overall risk in the placebo and vaccine groups, as well as estimate vaccine efficacy, using either a nonparametric Kaplan-Meier estimator or a marginalized Cox model.

```{r}

est_overall(dat=dat, t_0=578, method="KM")
est_overall(dat=dat, t_0=578, method="Cox")

```

The `est_ce` function allows us to compute controlled effects curves; see [Gilbert, Fong, Kenny, and Carone 2022](https://academic.oup.com/biostatistics/advance-article-abstract/doi/10.1093/biostatistics/kxac24/6644798) for more detail.

```{r}

ests_cox <- est_ce(dat=dat, type="Cox", t_0=578)
# ests_np <- est_ce(dat=dat, type="NP", t_0=578)
ests_np <- est_ce(dat=dat, type="NP", t_0=578,
                  params_np=params_ce_np(surv_type="survML-G"))
# ests_np2 <- est_ce(dat=dat, type="NP", t_0=578,
#                   params_np=params_ce_np(surv_type="survML-L"))
est_ov <- est_overall(dat=dat, t_0=578, method="KM")

if (F) {
  
  ests_np1 <- est_np(
    dat = dat,
    t_0 = 578,
    params = list(surv_type="Cox", q_n_type="zero")
  )
  
  ests_np2 <- est_np(
    dat = dat,
    t_0 = 578,
    params = list(surv_type="survSL", q_n_type="zero")
  )
  
  ests_np <- est_np(
    dat = dat,
    t_0 = 578,
    params = list(surv_type="survML-G", q_n_type="zero")
  )
  
}

```

The plot_ce function gives some basic plots

```{R}

plot_ce(ests_cox, ests_np)

```

The plots are `ggplot2` plot objects.
